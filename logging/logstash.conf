# Configuration Logstash pour ft_transcendence
input {
  # Réception des logs via TCP depuis le backend
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Parsing et enrichissement des logs

  # Ajout de timestamp si manquant
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Tag pour les erreurs
  if [level] == "error" {
    mutate {
      add_tag => ["error"]
    }
  }

  # Tag pour les warnings
  if [level] == "warn" {
    mutate {
      add_tag => ["warning"]
    }
  }

  # Extraction d'informations supplémentaires
  if [req] {
    mutate {
      add_field => {
        "http_method" => "%{[req][method]}"
        "http_url" => "%{[req][url]}"
      }
    }
  }

  if [res] {
    mutate {
      add_field => {
        "http_status" => "%{[res][statusCode]}"
      }
    }
  }
}

output {
  # Envoi vers Elasticsearch avec index par jour
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "transcendence-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
    user => "elastic"
    password => "transcendence_elk_2024"
  }

  # Debug: affichage dans stdout (optionnel, à commenter en production)
  stdout {
    codec => rubydebug
  }
}
